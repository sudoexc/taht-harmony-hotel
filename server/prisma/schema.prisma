generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum RoomType {
  ECONOM
  STANDARD
}

enum StayStatus {
  BOOKED
  CHECKED_IN
  CHECKED_OUT
  CANCELLED
}

enum PaymentMethod {
  CASH
  CARD
  PAYME
  CLICK
  OTHER
}

enum ExpenseCategory {
  SALARY
  INVENTORY
  UTILITIES
  REPAIR
  MARKETING
  OTHER
}

enum AppRole {
  ADMIN
  MANAGER
}

model User {
  id           String      @id @default(uuid())
  email        String      @unique
  passwordHash String
  createdAt    DateTime    @default(now())
  profile      Profile?
  roles        UserRole[]
  auditLogs    AuditLog[]
}

model Hotel {
  id                   String                @id @default(uuid())
  name                 String
  timezone             String                @default("Asia/Tashkent")
  createdAt            DateTime              @default(now())
  profiles             Profile[]
  rooms                Room[]
  stays                Stay[]
  payments             Payment[]
  expenses             Expense[]
  monthClosings        MonthClosing[]
  auditLogs            AuditLog[]
  customPaymentMethods CustomPaymentMethod[]
}

model Profile {
  id        String   @id
  user      User     @relation(fields: [id], references: [id], onDelete: Cascade)
  hotelId   String
  hotel     Hotel    @relation(fields: [hotelId], references: [id], onDelete: Cascade)
  fullName  String
  createdAt DateTime @default(now())
}

model UserRole {
  id     String  @id @default(uuid())
  userId String
  role   AppRole
  user   User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, role])
}

model Room {
  id        String   @id @default(uuid())
  hotelId   String
  hotel     Hotel    @relation(fields: [hotelId], references: [id], onDelete: Cascade)
  number    String
  floor     Int      @default(1)
  roomType  RoomType @default(STANDARD)
  capacity  Int      @default(2)
  basePrice Decimal  @default(0)
  active    Boolean  @default(true)
  notes     String?
  createdAt DateTime @default(now())

  stays Stay[]
}

model Stay {
  id                     String     @id @default(uuid())
  hotelId                String
  hotel                  Hotel      @relation(fields: [hotelId], references: [id], onDelete: Cascade)
  roomId                 String
  room                   Room       @relation(fields: [roomId], references: [id], onDelete: Cascade)
  guestName              String
  guestPhone             String?
  checkInDate            DateTime   @db.Date
  checkOutDate           DateTime   @db.Date
  status                 StayStatus @default(BOOKED)
  pricePerNight          Decimal    @default(0)
  weeklyDiscountAmount   Decimal    @default(0)
  manualAdjustmentAmount Decimal    @default(0)
  depositExpected        Decimal    @default(0)
  comment                String?
  createdAt              DateTime   @default(now())

  payments Payment[]
}

model Payment {
  id                String        @id @default(uuid())
  hotelId           String
  hotel             Hotel         @relation(fields: [hotelId], references: [id], onDelete: Cascade)
  stayId            String
  stay              Stay          @relation(fields: [stayId], references: [id], onDelete: Cascade)
  paidAt            DateTime      @default(now())
  method            PaymentMethod @default(CASH)
  customMethodLabel String?
  amount            Decimal       @default(0)
  comment           String?
  createdAt         DateTime      @default(now())
}

model Expense {
  id                String          @id @default(uuid())
  hotelId           String
  hotel             Hotel           @relation(fields: [hotelId], references: [id], onDelete: Cascade)
  spentAt           DateTime        @default(now())
  category          ExpenseCategory @default(OTHER)
  method            PaymentMethod   @default(CASH)
  customMethodLabel String?
  amount            Decimal         @default(0)
  comment           String?
  createdAt         DateTime        @default(now())
}

model CustomPaymentMethod {
  id        String   @id @default(uuid())
  hotelId   String
  hotel     Hotel    @relation(fields: [hotelId], references: [id], onDelete: Cascade)
  name      String
  createdAt DateTime @default(now())

  @@unique([hotelId, name])
}

model MonthClosing {
  id        String   @id @default(uuid())
  hotelId   String
  hotel     Hotel    @relation(fields: [hotelId], references: [id], onDelete: Cascade)
  month     String
  closedAt  DateTime @default(now())
  totalsJson Json?

  @@unique([hotelId, month])
}

model AuditLog {
  id        String   @id @default(uuid())
  hotelId   String
  hotel     Hotel    @relation(fields: [hotelId], references: [id], onDelete: Cascade)
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  action    String
  entity    String
  entityId  String?
  payload   Json?
  result    Json?
  createdAt DateTime @default(now())

  @@index([hotelId, createdAt])
}
